<!DOCTYPE html>
<html lang="en" data-bs-theme="white">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <title>Moodify</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <link
      rel="canonical"
      href="https://getbootstrap.com/docs/5.3/examples/navbar-static/"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"
    />

    <link href="navbar-static.css" rel="stylesheet" />
    <link
      href="{{ url_for('static', filename='/css/app.css') }}"
      rel="stylesheet"
    />
    <script src="{{ url_for('static', filename='/app.js') }}" defer></script>
  </head>
  <body>
    <nav class="navbar shadow-sm justify-content-between navbar-expand-lg bg-body-tertiary fixed-top">
      <a href="/" class="navbar-brand ms-3">
        <img style="height: 40px; transform: scale(1.5)" src="{{ url_for('static', filename='/images/logo1.png') }}"/>
      </a>
      <h1 id="welcome" class="text-primary fs-1">Welcome</h1>
        <div class="navbar_options me-4">
        <ul class="nav nav-underline">
          <li class="nav-item">
            <a href="/" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showHistory()">History</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showCamera()">Show Emotion</a>
          </li>
          <li class="nav-item">
            <a href="/logout" class="btn btn-primary btn-lg p-2">Logout</a>
          </li>
        </ul>
      </div>
    </nav>
    <script>
      fetch('/get_username')
  .then(response => response.json())
  .then(data => {
    if (data.username) {
      document.getElementById('welcome').textContent = 'Welcome ' + data.username;
    }
  });

    </script>

    <!-- Camera Section -->
    <div class="camera-container m-0" id="camera-section" style="display: block">
      <div class="top-banner mb-0">
        <h1 class="text-dark text-center mt-5 pt-5 mb-0" style="font-size: 3em">
          Let's get <br /> Started
        </h1>
      </div>
      <div class="video-ui-container m-0">
        <div class="video-feed-container">
          <img src="{{ url_for('video_feed') }}" id="video" class="rounded border m-0" />
          <canvas id="canvas" width="100%" height="100%" class="m-0"></canvas>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-2">
        <button id="generateButton" class="btn btn btn-warning text-dark border-secondary btn-lg p-2">
          Generate <br /> Playlist
        </button>
        <div id="loader" style="display: none">
          <div class="loading loading01">
            <span>G</span><span>E</span><span>N</span><span>E</span><span>R</span><span>A</span><span>T</span><span>I</span><span>N</span><span>G</span>
          </div>
          <div class="progress-bar"></div>
        </div>
      </div>
    </div>

    <!-- Playlist Section -->
    <div class="playlist-container m-0" style="display: none">
      <div class="emotion-display-banner">
        <h1 class="mt-5 pt-5 text-center">Detected Emotion:</h1>
        <div class="emoji-background ms-5 me-5">
          <div class="content">
            <h1 id="detected-emotion"></h1>
          </div>
        </div>
      </div>
      <h1 class="text-dark-emphasis text-center mt-3 mb-0">Your Playlist:</h1>
      <div class="playlist-display">
        <table id="playlist-table" class="music-table">
          <tr>
            <th>#</th>
            <th></th>
            <th>Name</th>
            <th>Artist</th>
            <th>Album</th>
          </tr>
        </table>
      </div>
    </div>

    <!-- History Section (Hidden by default) -->
    <div class="container mt-5 pt-5" id="history-section" style="display: none">
      <h2 class="text-center">Emotion History</h2>
      <div id="history-content" class="mt-3">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Emotion</th>
              <th scope="col">Timestamp</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td colspan="3" class="text-center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function showHistory() {
        document.getElementById("camera-section").style.display = "none";
        document.querySelector(".playlist-container").style.display = "none";
        document.getElementById("history-section").style.display = "block";

        fetch("/get_history")
          .then(res => res.json())
          .then(data => {
            const tableBody = document.getElementById("history-table-body");
            tableBody.innerHTML = "";
            if (data.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3" class="text-center">No history available.</td></tr>`;
              return;
            }
            data.forEach((item, index) => {
              const row = `<tr><td>${index + 1}</td><td>${item.emotion}</td><td>${item.timestamp}</td></tr>`;
              tableBody.innerHTML += row;
            });
          })
          .catch(() => {
            document.getElementById("history-table-body").innerHTML = `<tr><td colspan="3" class="text-center text-danger">Failed to load history.</td></tr>`;
          });
      }

      function showCamera() {
        document.getElementById("history-section").style.display = "none";
        document.querySelector(".playlist-container").style.display = "none";
        document.getElementById("camera-section").style.display = "block";
        location.reload(); 
      }
    </script>
  </body>
</html>
